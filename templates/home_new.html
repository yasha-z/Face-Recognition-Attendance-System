<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Family Recognition Helper</title>
    <!--bootstrap cdn link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="
    sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!--google font link-->
    <link href="https://fonts.cdnfonts.com/css/brittany-signature" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="../static/style.css" rel="stylesheet">
    <style>
        body {
            font-size: 18px;
            font-family: Arial, sans-serif;
        }
        .large-text {
            font-size: 24px !important;
        }
        .huge-text {
            font-size: 36px !important;
        }
        .btn-large {
            padding: 20px 40px;
            font-size: 24px;
            margin: 15px;
        }
        .card-header {
            background-color: #e8f4f8;
            border-bottom: 2px solid #007bff;
        }
        .family-member-card {
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
        }
        .video-container {
            border: 3px solid #007bff;
            border-radius: 15px;
            padding: 10px;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!--Header Section-->
        <div class="row">
            <div class="container">
                <header class="d-flex flex-wrap align-items-center justify-content-center py-3 mb-4 border-bottom">
                    <img src="../static/images/companylogo.jpg" width="80" height="80" class="d-inline-block align-top" alt="Family Helper Logo">
                    <span class="navbar-text fw-bold huge-text mx-auto text-primary">
                        Family Recognition Helper
                    </span>
                </header>
                <div class="d-flex justify-content-center large-text align-items-center mx-3 pb-4" >
                    <span class="navbar-text fw-semibold" style="margin-right:10px">
                        Today is: 
                    </span>
                    <span id="currDate" class="fw-bold text-primary">{{datetoday2}}</span>
                </div>
            </div>
        </div>

        <!--Main Content-->
        <div class="row">
            <!-- Camera and Recognition Section -->
            <div class="col-lg-8">
                <div class="card family-member-card">
                    <div class="card-header text-center">
                        <h2 class="huge-text text-primary mb-0">
                            <i class="material-icons" style="font-size: 40px; vertical-align: middle;">camera_alt</i>
                            Who is this person?
                        </h2>
                    </div>
                    <div class="card-body text-center">
                        <div class="video-container mb-4" id="cameraContainer">
                            <img id="videoFeed" style="width: 100%; max-width: 640px; height: auto; border-radius: 10px; display: none;" />
                            <div id="cameraPlaceholder" class="text-center p-5" style="background-color: #f0f0f0; border-radius: 10px;">
                                <i class="material-icons" style="font-size: 80px; color: #ccc;">camera_alt</i>
                                <p class="large-text mt-3">Click "Start Camera" to begin</p>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-3">
                            <button id="startCameraBtn" class="btn btn-primary btn-large" onclick="startCamera()">
                                <i class="material-icons" style="font-size: 30px; vertical-align: middle;">videocam</i>
                                Start Camera
                            </button>
                            
                            <button id="recognizeBtn" class="btn btn-success btn-large" onclick="startRecognition()" style="display: none;">
                                <i class="material-icons" style="font-size: 30px; vertical-align: middle;">visibility</i>
                                Who is this person?
                            </button>
                            
                            <button id="stopCameraBtn" class="btn btn-secondary btn-large" onclick="stopCamera()" style="display: none;">
                                <i class="material-icons" style="font-size: 30px; vertical-align: middle;">visibility_off</i>
                                Stop Camera
                            </button>
                        </div>
                        
                        <div id="recognitionResult" class="mt-4" style="display: none;">
                            <div class="alert alert-info huge-text text-center" role="alert">
                                <strong><span id="resultText">Analyzing...</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family Members List -->
            <div class="col-lg-4">
                <div class="card family-member-card">
                    <div class="card-header text-center">
                        <h3 class="large-text text-primary mb-0">
                            <i class="material-icons" style="font-size: 30px; vertical-align: middle;">family_restroom</i>
                            Your Family Members
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 text-center">
                            <span class="large-text fw-semibold">
                                Total Family Members: <span class="text-primary">{{totalreg}}</span>
                            </span>
                        </div>
                        
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-success btn-large" data-bs-toggle="modal" data-bs-target="#addFamilyModal">
                                <i class="material-icons" style="font-size: 24px; vertical-align: middle;">person_add</i>
                                Add New Family Member
                            </button>
                        </div>

                        <!-- Family members list would go here -->
                        <div id="familyMembersList">
                            <!-- This will be populated with family member cards -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Display -->
        {% if mess %}
        <div class="row mt-4">
            <div class="col">
                <div class="alert alert-info large-text text-center" role="alert">
                    {{ mess }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Add Family Member Modal -->
    <div class="modal fade" id="addFamilyModal" tabindex="-1" aria-labelledby="addFamilyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title large-text" id="addFamilyModalLabel">
                        <i class="material-icons" style="vertical-align: middle;">person_add</i>
                        Add New Family Member
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/add_family" method="POST">
                    <div class="modal-body">
                        <div class="mb-4">
                            <label for="familyMemberName" class="form-label large-text fw-semibold">Family Member's Name:</label>
                            <input type="text" class="form-control large-text" id="familyMemberName" name="familyMemberName" 
                                   placeholder="Enter name (e.g., John, Mom, Sister)" required>
                        </div>
                        <div class="mb-4">
                            <label for="relationship" class="form-label large-text fw-semibold">Relationship:</label>
                            <select class="form-select large-text" id="relationship" name="relationship" required>
                                <option value="">Choose relationship...</option>
                                <option value="spouse">Spouse</option>
                                <option value="child">Child</option>
                                <option value="parent">Parent</option>
                                <option value="sibling">Brother/Sister</option>
                                <option value="grandchild">Grandchild</option>
                                <option value="friend">Friend</option>
                                <option value="caregiver">Caregiver</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="alert alert-info large-text">
                            <i class="material-icons" style="vertical-align: middle;">info</i>
                            After clicking "Start Adding Photos", look at the camera and let it take 50 photos of this person.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary large-text" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary large-text">
                            <i class="material-icons" style="vertical-align: middle;">camera_alt</i>
                            Start Adding Photos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cameraActive = false;
        let recognitionActive = false;

        // Display current date
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        });

        function startCamera() {
            cameraActive = true;
            
            // Hide placeholder and show video feed
            document.getElementById('cameraPlaceholder').style.display = 'none';
            document.getElementById('videoFeed').style.display = 'block';
            document.getElementById('videoFeed').src = "{{ url_for('video_feed') }}?" + new Date().getTime();
            
            // Update buttons
            document.getElementById('startCameraBtn').style.display = 'none';
            document.getElementById('recognizeBtn').style.display = 'block';
            document.getElementById('stopCameraBtn').style.display = 'block';
        }

        function startRecognition() {
            if (!cameraActive) {
                startCamera();
            }
            
            recognitionActive = true;
            document.getElementById('recognitionResult').style.display = 'block';
            document.getElementById('resultText').textContent = 'Looking for faces...';
            document.getElementById('recognizeBtn').disabled = true;
            document.getElementById('recognizeBtn').textContent = 'Analyzing...';
            
            // Start recognition process
            fetch('/start_recognition')
                .then(response => response.json())
                .then(data => {
                    if (data.person_name) {
                        if (data.person_name === 'No face detected' || data.person_name === 'Unknown') {
                            document.getElementById('resultText').innerHTML = 
                                '<span style="color: orange;">No face detected or person not recognized</span>';
                        } else {
                            document.getElementById('resultText').innerHTML = 
                                '<span style="color: green;">This is: ' + data.person_name + '</span>';
                        }
                    }
                })
                .catch(error => {
                    document.getElementById('resultText').innerHTML = 
                        '<span style="color: red;">Error occurred during recognition</span>';
                    console.error('Recognition error:', error);
                })
                .finally(() => {
                    document.getElementById('recognizeBtn').disabled = false;
                    document.getElementById('recognizeBtn').innerHTML = 
                        '<i class="material-icons" style="font-size: 30px; vertical-align: middle;">visibility</i> Who is this person?';
                    recognitionActive = false;
                });
        }

        function stopCamera() {
            cameraActive = false;
            recognitionActive = false;
            
            // Stop video feed
            fetch('/stop_recognition');
            
            // Hide video and show placeholder
            document.getElementById('videoFeed').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'block';
            document.getElementById('recognitionResult').style.display = 'none';
            
            // Reset buttons
            document.getElementById('startCameraBtn').style.display = 'block';
            document.getElementById('recognizeBtn').style.display = 'none';
            document.getElementById('stopCameraBtn').style.display = 'none';
        }
    </script>
</body>
</html>